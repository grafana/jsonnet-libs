JSONNET_FMT := jsonnetfmt -n 2 --max-blank-lines 2 --string-style s --comment-style s

.PHONY: all
all: build dashboards_out prometheus_alerts.yaml prometheus_rules.yaml test

vendor: $(wildcard jsonnetfile.json)
ifneq ("$(wildcard jsonnetfile.json)","")
	jb install
endif

.PHONY: build
build: vendor

.PHONY: fmt
fmt:
	find . -name 'vendor' -prune -o -name '*.libsonnet' -print -o -name '*.jsonnet' -print | \
		xargs -n 1 -- $(JSONNET_FMT) -i

.PHONY: lint
lint: build lint-pint
	@set -e; \
	find . -name 'vendor' -prune -o -name '*.libsonnet' -print -o -name '*.jsonnet' -print | \
		while read f; do \
			$(JSONNET_FMT) "$$f" | diff -u "$$f" - || exit 1; \
		done; \
	mixtool lint mixin.libsonnet

.PHONY: lint-pint
lint-pint: prometheus_alerts.yaml prometheus_rules.yaml
	pint lint --min-severity=info --fail-on=warning prometheus_rules_out/

dashboards_out: mixin.libsonnet $(wildcard **/*.libsonnet) $(wildcard **/*.jsonnet) $(wildcard panels/*) $(wildcard signals/*)
	@mkdir -p dashboards_out
	mixtool generate dashboards mixin.libsonnet -d dashboards_out

prometheus_alerts.yaml: $(wildcard vendor/**/alerts.yaml) $(wildcard vendor/**/alerts.libsonnet) mixin.libsonnet $(wildcard alerts.libsonnet) $(wildcard signals/*) $(wildcard alerts/*)
	@mkdir -p prometheus_rules_out
	@if [ -f alerts.libsonnet -o -d alerts ]; then \
		mixtool generate alerts mixin.libsonnet -a prometheus_rules_out/prometheus_alerts.yaml; \
	else \
		touch prometheus_rules_out/prometheus_alerts.yaml; \
	fi
prometheus_rules.yaml: $(wildcard vendor/**/rules.yaml) $(wildcard vendor/**/rules.libsonnet) mixin.libsonnet $(wildcard rules.libsonnet) $(wildcard signals/*) $(wildcard rules/*)
	@if [ -f rules.libsonnet -o -d rules ]; then \
		mixtool generate rules mixin.libsonnet -a prometheus_rules_out/prometheus_rules.yaml; \
	else \
		touch prometheus_rules_out/prometheus_rules.yaml; \
	fi

.PHONY: test-env-up
test-env-up:
	# Start Grafana and Prometheus
	docker compose -f ../tests/docker/docker-compose.yml up -d
	# Wait for Grafana to be ready
	@timeout 30s bash -c 'until curl -s http://localhost:3000/api/health | grep "ok"; do sleep 1; done'

.PHONY: test-env-down
test-env-down:
	docker compose -f ../tests/docker/docker-compose.yml down

.PHONY: test-dashboards
test-dashboards: test-env-up
	export GRAFANA_URL=http://localhost:3000 && $(MAKE) deploy_dashboards
	@mkdir -p cypress/e2e
	# Build the test image
	docker build -f ../tests/cypress/Dockerfile -t cypress-mixin-test ../tests/cypress
	# Create screenshots directory if it doesn't exist
	@mkdir -p screenshots
	# Run tests
	docker run --rm --network=host \
		-v $$(pwd)/dashboards_out:/e2e/dashboards_out:ro \
		-v $$(pwd)/screenshots:/e2e/cypress/screenshots \
		-w /e2e \
		--entrypoint /bin/sh \
		cypress-mixin-test \
		-c 'node generate-fixture.js && cypress run \
		--config-file /e2e/cypress.config.js \
		--project /e2e'
	$(MAKE) test-env-down

.PHONY: deploy_dashboards
deploy_dashboards:
ifdef GRAFANA_URL
	grr apply mixin.libsonnet --target "Dashboard.*" --target "DashboardFolder.*"
else
	$(warning GRAFANA_URL is not set, skipping grafana dashboards deployment)
endif

.PHONY: deploy_rules
deploy_rules:
ifdef CORTEX_ADDRESS
	grr apply mixin.libsonnet --target "PrometheusRuleGroup.*"
else
	$(warning CORTEX_ADDRESS is not set, skipping prometheus alerts deployment)
endif

.PHONY: deploy
deploy: deploy_rules deploy_dashboards

.PHONY: test
test: test-dashboards
	@if [ -f tests/prometheus_*.yaml ]; then \
		echo "Execute promtool tests:"; \
		promtool test rules tests/prometheus_*.yaml; \
	else \
		echo "No tests/prometheus_*.yaml files found, skipping promtool test."; \
	fi

.PHONY: clean
clean:
	rm -rf dashboards_out prometheus_rules_out
	rm -rf screenshots
	$(MAKE) test-env-down
