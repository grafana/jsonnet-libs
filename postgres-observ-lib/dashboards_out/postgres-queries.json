{
   "description": "PostgreSQL query performance analysis.\n\nRequires pg_stat_statements extension:\n\n1. Add to postgresql.conf:\n   shared_preload_libraries = 'pg_stat_statements'\n\n2. Restart PostgreSQL\n\n3. Create extension:\n   CREATE EXTENSION pg_stat_statements;\n",
   "links": [
      {
         "asDropdown": false,
         "includeVars": true,
         "keepTime": true,
         "tags": [
            "postgres",
            "database"
         ],
         "title": "All PostgreSQL dashboards",
         "type": "dashboards"
      }
   ],
   "panels": [
      {
         "collapsed": false,
         "gridPos": {
            "h": 1,
            "w": 0,
            "x": 0,
            "y": 0
         },
         "panels": [ ],
         "title": "Query Analysis",
         "type": "row"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${datasource}"
         },
         "description": "Rate of execution time consumption per second for each query.\n\nShows how much CPU/execution time each query is currently consuming.\nHigher values indicate queries that are actively using more resources.\n\nFormula: rate(pg_stat_statements_seconds_total[$__rate_interval])\n\nUse this to identify queries that are currently impacting performance.\n",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 30,
                  "gradientMode": "opacity",
                  "lineInterpolation": "smooth",
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "s"
            },
            "overrides": [
               {
                  "matcher": {
                     "id": "byFrameRefID",
                     "options": "Top queries by total time"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "s"
                     }
                  ]
               }
            ]
         },
         "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 1
         },
         "options": {
            "legend": {
               "calcs": [ ],
               "displayMode": "list"
            },
            "tooltip": {
               "mode": "multi",
               "sort": "desc"
            }
         },
         "pluginVersion": "v11.0.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "topk(10, rate(pg_stat_statements_seconds_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"}[$__rate_interval]))",
               "format": "time_series",
               "instant": false,
               "legendFormat": "{{ queryid }} ({{ datname }})",
               "refId": "Top queries by total time"
            }
         ],
         "title": "Query time consumption rate",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${datasource}"
         },
         "description": "Average execution time per call for each query.\n\nShows how long each query takes on average when executed.\nHigher values indicate slow individual query executions.\n\nFormula: total_time / calls\n\nUse this to find queries that need optimization (slow but maybe not called often).\n",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 30,
                  "gradientMode": "opacity",
                  "lineInterpolation": "smooth",
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "s"
            },
            "overrides": [
               {
                  "matcher": {
                     "id": "byFrameRefID",
                     "options": "Slowest queries by mean time"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "s"
                     }
                  ]
               }
            ]
         },
         "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 1
         },
         "options": {
            "legend": {
               "calcs": [ ],
               "displayMode": "list"
            },
            "tooltip": {
               "mode": "multi",
               "sort": "desc"
            }
         },
         "pluginVersion": "v11.0.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "topk(10,\n  (\n    pg_stat_statements_seconds_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"}\n    /\n    (pg_stat_statements_calls_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"} + 1)\n  )\n)\n",
               "format": "time_series",
               "instant": false,
               "legendFormat": "{{ queryid }} ({{ datname }})",
               "refId": "Slowest queries by mean time"
            }
         ],
         "title": "Slowest queries by mean time",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${datasource}"
         },
         "description": "Rate of query executions per second.\n\nShows how often each query is being called.\nHigh-frequency queries are candidates for caching or connection pooling.\n\nFormula: rate(pg_stat_statements_calls_total[$__rate_interval])\n",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 30,
                  "gradientMode": "opacity",
                  "lineInterpolation": "smooth",
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "ops"
            },
            "overrides": [
               {
                  "matcher": {
                     "id": "byFrameRefID",
                     "options": "Most frequent queries"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "ops"
                     }
                  ]
               }
            ]
         },
         "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 9
         },
         "options": {
            "legend": {
               "calcs": [ ],
               "displayMode": "list"
            },
            "tooltip": {
               "mode": "multi",
               "sort": "desc"
            }
         },
         "pluginVersion": "v11.0.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "topk(10, rate(pg_stat_statements_calls_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"}[$__rate_interval]))",
               "format": "time_series",
               "instant": false,
               "legendFormat": "{{ queryid }} ({{ datname }})",
               "refId": "Most frequent queries"
            }
         ],
         "title": "Most frequent queries",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "prometheus",
            "uid": "${datasource}"
         },
         "description": "Rate of rows returned/affected per second for each query.\n\nHigh values may indicate:\n- Missing WHERE clauses (full table scans)\n- Missing LIMIT clauses\n- Inefficient joins returning too many rows\n\nFormula: rate(pg_stat_statements_rows_total[$__rate_interval])\n",
         "fieldConfig": {
            "defaults": {
               "custom": {
                  "fillOpacity": 30,
                  "gradientMode": "opacity",
                  "lineInterpolation": "smooth",
                  "lineWidth": 2,
                  "showPoints": "never"
               },
               "unit": "rows/s"
            },
            "overrides": [
               {
                  "matcher": {
                     "id": "byFrameRefID",
                     "options": "Top queries by rows"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "rows/s"
                     }
                  ]
               }
            ]
         },
         "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 9
         },
         "options": {
            "legend": {
               "calcs": [ ],
               "displayMode": "list"
            },
            "tooltip": {
               "mode": "multi",
               "sort": "desc"
            }
         },
         "pluginVersion": "v11.0.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "topk(10, rate(pg_stat_statements_rows_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"}[$__rate_interval]))",
               "format": "time_series",
               "instant": false,
               "legendFormat": "{{ queryid }} ({{ datname }})",
               "refId": "Top queries by rows"
            }
         ],
         "title": "Top queries by rows",
         "type": "timeseries"
      },
      {
         "datasource": {
            "type": "datasource",
            "uid": "-- Mixed --"
         },
         "description": "Comprehensive query performance statistics from pg_stat_statements.\n\nColumns explained:\n• Time/s: Execution time rate (seconds of query time per second) - matches \"Query time consumption rate\" graph\n• Calls/s: Call rate (queries per second) - matches \"Most frequent queries\" graph\n• Avg Time: Average time per call (total_time / calls) - matches \"Slowest queries\" graph\n• Total Time: Cumulative execution time since stats reset\n\nSort by Time/s to find currently impactful queries.\nSort by Avg Time to find slow individual queries.\n",
         "fieldConfig": {
            "overrides": [
               {
                  "matcher": {
                     "id": "byName",
                     "options": "Time/s"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "s"
                     },
                     {
                        "id": "description",
                        "value": "Execution time rate (seconds consumed per second). Higher = more current load. Matches \"Query time consumption rate\" graph."
                     }
                  ]
               },
               {
                  "matcher": {
                     "id": "byName",
                     "options": "Calls/s"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "ops"
                     },
                     {
                        "id": "description",
                        "value": "Call rate (executions per second). Higher = more frequently called. Matches \"Most frequent queries\" graph."
                     }
                  ]
               },
               {
                  "matcher": {
                     "id": "byName",
                     "options": "Avg Time"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "s"
                     },
                     {
                        "id": "description",
                        "value": "Average execution time per call (total_time / calls). Higher = slower query. Matches \"Slowest queries\" graph."
                     }
                  ]
               },
               {
                  "matcher": {
                     "id": "byName",
                     "options": "Total Time"
                  },
                  "properties": [
                     {
                        "id": "unit",
                        "value": "s"
                     },
                     {
                        "id": "description",
                        "value": "Cumulative execution time since pg_stat_statements was reset."
                     }
                  ]
               },
               {
                  "matcher": {
                     "id": "byName",
                     "options": "Query ID"
                  },
                  "properties": [
                     {
                        "id": "description",
                        "value": "Unique query identifier from pg_stat_statements. Use this to find the actual query text in the database."
                     }
                  ]
               },
               {
                  "matcher": {
                     "id": "byName",
                     "options": "Database"
                  },
                  "properties": [
                     {
                        "id": "description",
                        "value": "Database where the query was executed."
                     }
                  ]
               },
               {
                  "matcher": {
                     "id": "byName",
                     "options": "User"
                  },
                  "properties": [
                     {
                        "id": "description",
                        "value": "PostgreSQL user who executed the query."
                     }
                  ]
               }
            ]
         },
         "gridPos": {
            "h": 10,
            "w": 24,
            "x": 0,
            "y": 19
         },
         "options": {
            "sortBy": [
               {
                  "desc": true,
                  "displayName": "Time/s"
               }
            ]
         },
         "pluginVersion": "v11.0.0",
         "targets": [
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "rate(pg_stat_statements_seconds_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"}[$__rate_interval])",
               "format": "table",
               "instant": true,
               "refId": "TimeRate"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "rate(pg_stat_statements_calls_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"}[$__rate_interval])",
               "format": "table",
               "instant": true,
               "refId": "CallsRate"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "pg_stat_statements_seconds_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"} / (pg_stat_statements_calls_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"} + 1)",
               "format": "table",
               "instant": true,
               "refId": "MeanTime"
            },
            {
               "datasource": {
                  "type": "prometheus",
                  "uid": "${datasource}"
               },
               "expr": "pg_stat_statements_seconds_total{job=~\"$job\",cluster=~\"$cluster\",instance=~\"$instance\"}",
               "format": "table",
               "instant": true,
               "refId": "TotalTime"
            }
         ],
         "title": "Query Statistics",
         "transformations": [
            {
               "id": "merge"
            },
            {
               "id": "organize",
               "options": {
                  "excludeByName": {
                     "Time": true,
                     "Time 1": true,
                     "Time 2": true,
                     "Time 3": true,
                     "Time 4": true,
                     "Time 5": true,
                     "__name__": true,
                     "cluster": true,
                     "environment": true,
                     "instance": true,
                     "job": true,
                     "server_id": true
                  },
                  "indexByName": {
                     "Value #CallsRate": 4,
                     "Value #MeanTime": 5,
                     "Value #TimeRate": 3,
                     "Value #TotalTime": 6,
                     "datname": 1,
                     "queryid": 0,
                     "user": 2
                  },
                  "renameByName": {
                     "Value #CallsRate": "Calls/s",
                     "Value #MeanTime": "Avg Time",
                     "Value #TimeRate": "Time/s",
                     "Value #TotalTime": "Total Time",
                     "datname": "Database",
                     "queryid": "Query ID",
                     "user": "User"
                  }
               }
            },
            {
               "id": "sortBy",
               "options": {
                  "fields": { },
                  "sort": [
                     {
                        "desc": true,
                        "field": "Time/s"
                     }
                  ]
               }
            }
         ],
         "type": "table"
      }
   ],
   "schemaVersion": 39,
   "tags": [
      "postgres",
      "database",
      "pg_stat_statements"
   ],
   "templating": {
      "list": [
         {
            "label": "Data source",
            "name": "datasource",
            "query": "prometheus",
            "regex": "",
            "type": "datasource"
         },
         {
            "allValue": ".+",
            "datasource": {
               "type": "prometheus",
               "uid": "${datasource}"
            },
            "includeAll": true,
            "label": "Job",
            "multi": true,
            "name": "job",
            "query": "label_values({__name__=~\"pg_stat_statements_calls_total\"}, job)",
            "refresh": 2,
            "sort": 1,
            "type": "query"
         },
         {
            "allValue": ".+",
            "datasource": {
               "type": "prometheus",
               "uid": "${datasource}"
            },
            "includeAll": true,
            "label": "Cluster",
            "multi": true,
            "name": "cluster",
            "query": "label_values({__name__=~\"pg_stat_statements_calls_total\",job=~\"$job\"}, cluster)",
            "refresh": 2,
            "sort": 1,
            "type": "query"
         },
         {
            "allValue": null,
            "datasource": {
               "type": "prometheus",
               "uid": "${datasource}"
            },
            "includeAll": false,
            "label": "Instance",
            "multi": false,
            "name": "instance",
            "query": "label_values({__name__=~\"pg_stat_statements_calls_total\",job=~\"$job\",cluster=~\"$cluster\"}, instance)",
            "refresh": 2,
            "sort": 1,
            "type": "query"
         }
      ]
   },
   "time": {
      "from": "now-6h",
      "to": "now"
   },
   "timezone": "utc",
   "title": "PostgreSQL Query Performance",
   "uid": "postgres-queries"
}
