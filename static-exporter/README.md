# static-exporter jsonnet library

Export metrics that are relatively static.

## Usage

Install it with jsonnet-bundler:

```console
jb install github.com/grafana/jsonnet-libs/static-exporter
```

## Example

```jsonnet
// environments/default/main.jsonnet
local static_exporter = import 'github.com/grafana/jsonnet-libs/static-expoter/main.libsonnet';

{
  team_holiday_exporter:
    static_exporter.new('team-holiday-exporter')
    + static_exporter.withMetrics([
      static_exporter.metric.new(
        'holidays_day_count',
        'Available official holidays',
      )
      + static_exporter.metric.withValue({location: 'EMEA'}, 30)
      + static_exporter.metric.withValue({location: 'NASA'}, 25)
      + static_exporter.metric.withValue({location: 'APAC'}, 37),

      static_exporter.metric.new(
        'team_info',
        'Information about team members',
      )
      + static_exporter.metric.withLabelMapList([
        {name: 'Hiro', team: 'frontend', location:'NASA'},
        {name: 'Baymax', team: 'frontend', location:'EMEA'},
        {name: 'Honey', team: 'platform', location:'EMEA'},
        {name: 'Tomago', team: 'platform', location:'APAC'},
        {name: 'Wasabi', team: 'mobile', location:'NASA'},
        {name: 'Fred', team: 'mobile', location:'APAC'},
      ]),
    ]),
}
```

## Using shell based implementation

The original implementation using the Apache web server contains quite a few dependencies that might be tricky to keep updated. An optional [busybox] based implementation can be used by supplying the `shell_exporter` flag:following

```jsonnet
    static_exporter.new('team-holiday-exporter', shell_exporter=true)
```

This variant uses a [distroless] image, runs as non-root and comes with a health check.

[distroless]:https://github.com/GoogleContainerTools/distroless
[busybox]:https://busybox.net/

## Updating httpd.conf

There is a default httpd.conf that was added to this library.
It was generated by running the following:

```
docker run --rm httpd:2.4 cat /usr/local/apache2/conf/httpd.conf httpd.conf
```

If there is a downstream change that requires updating this config file, run the above command and then add the following snippet to the `<Directory "/usr/local/apache2/htdocs"` block:

```
  <IfModule mod_headers.c>
        Header set Content-Type: "text/plain; version=0.0.4"
    </IfModule>
```

This change adds a Header to the requests that enables Prometheus 3.x to scrape the static exporter.
