groups:
  - name: gcp
    rules:
      - alert: GcpCEHighCpuUtilization
        expr: |
          100 * avg by (job,project_id,instance_name) (stackdriver_gce_instance_compute_googleapis_com_instance_cpu_utilization{job=~".+",project_id=~".+",instance_name=~".+"}) > 85
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: critical
          service: 'Compute Engine'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'CPU utilization is too high.'
          description: 'The VM {{ $labels.instance_name }} is under heavy load and may become unresponsive.'
          dashboard_uid: 'f115fe73641347c43415535d77e2dc0f'

  - name: gcp
    rules:
      - alert: GcpCEHighIOLatency
        expr: |
          avg by (job,project_id,instance_id)(stackdriver_gce_instance_compute_googleapis_com_instance_disk_average_io_latency{job=~".+",project_id=~".+",instance_id=~".+"}) > 5000
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: critical
          service: 'Compute Engine'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'IO latency is too high.'
          description: 'Check for I/O bottlenecks and upgrade to SSD if necessary.'
          dashboard_uid: 'f115fe73641347c43415535d77e2dc0f'

  - name: gcp
    rules:
      - alert: GcpCloudSQLHighCpu
        expr: |
          100 * avg by (job,project_id,instance,database_id) (stackdriver_cloudsql_database_cloudsql_googleapis_com_database_cpu_utilization{job=~".+",project_id=~".+",instance=~".+", database_id=~".+"}) > 80
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: critical
          service: 'Cloud SQL'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'CPU utilization is too high.'
          description: 'Check for high CPU queries and optimize them, or scale up the instance if sustained high usage.'
          dashboard_uid: 'cc710d49022fdd69bed0e992891863e9'

  - name: gcp
    rules:
      - alert: GcpCloudSQLMemoryUsage
        expr: |
          100 * avg by (job,project_id,instance,database_id) (stackdriver_cloudsql_database_cloudsql_googleapis_com_database_memory_utilization{job=~".+",project_id=~".+",instance=~".+", database_id=~".+"}) > 85
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: critical
          service: 'Cloud SQL'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'Memory utilization is too high.'
          description: 'Review high-memory queries or add more memory to the instance.'
          dashboard_uid: 'cc710d49022fdd69bed0e992891863e9'

  - name: gcp
    rules:
      - alert: GcpCloudSQLDiskUsage
        expr: |
          100 * avg by (job,project_id,instance,database_id) (stackdriver_cloudsql_database_cloudsql_googleapis_com_database_disk_utilization{job=~".+",project_id=~".+",instance=~".+", database_id=~".+"}) > 85
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: critical
          service: 'Cloud SQL'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'Disk utilization is too high.'
          description: 'Delete or archive unused data, or increase disk size.'
          dashboard_uid: 'cc710d49022fdd69bed0e992891863e9'

  - name: gcp
    rules:
      - alert: GcpCloudSQLActiveConnections
        expr: |
          avg by (job,project_id,instance, database_id) (stackdriver_cloudsql_database_cloudsql_googleapis_com_database_mysql_threads{thread_kind="THREADS_CONNECTED", job=~".+",project_id=~".+",instance=~".+", database_id=~".+"}) > 0.9 * avg by (job,project_id,instance, database_id) (stackdriver_cloudsql_database_cloudsql_googleapis_com_database_mysql_max_connections{job=~".+",project_id=~".+",instance=~".+", database_id=~".+"})
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: critical
          service: 'Cloud SQL'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'Too many active connections.'
          description: 'Investigate connection pooling settings and connection management in your application.'
          dashboard_uid: 'cc710d49022fdd69bed0e992891863e9'

  - name: gcp
    rules:
      - alert: GcpCloudSQLAbortedConnections
        expr: |
          sum by(job, instance, project_id)(rate(stackdriver_cloudsql_database_cloudsql_googleapis_com_database_mysql_aborted_connects_count[5m])) > 5
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: critical
          service: 'Cloud SQL'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'More than 5 failed connections in 5 minutes'
          description: 'Verify credentials and network settings; check for firewall rules blocking connections.'
          dashboard_uid: 'cc710d49022fdd69bed0e992891863e9'

  - name: gcp
    rules:
      - alert: GcpCloudSQLLagSecondsBehindMaster
        expr: |
          avg by (job,project_id,instance, database_id) (stackdriver_cloudsql_database_cloudsql_googleapis_com_database_mysql_replication_seconds_behind_master) > 5
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: warning
          service: 'Cloud SQL'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'More than 5 seconds lag between read replica and primary.'
          description: 'Check network latency between primary and replica; adjust configurations to optimize replication.'
          dashboard_uid: 'cc710d49022fdd69bed0e992891863e9'

  - name: gcp
    rules:
      - alert: GcpPubSubNumUndeliveredMessages
        expr: |
          avg by (job,project_id,instance)(stackdriver_pubsub_subscription_pubsub_googleapis_com_subscription_num_undelivered_messages{job=~".+",project_id=~".+",instance=~".+"}) > 1000
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: warning
          service: 'Pub/Sub'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'More than 1000 messages.'
          description: 'Scale up subscribers or adjust message processing capacity.'
          dashboard_uid: '2abad1eb5e4873b95e9176e7ef10a30c'

  - name: gcp
    rules:
      - alert: GcpPubSubUnackedMessageAge
        expr: |
          avg by (job,project_id,instance)(stackdriver_pubsub_subscription_pubsub_googleapis_com_subscription_oldest_unacked_message_age{job=~".+",project_id=~".+",instance=~".+"}) > 60
        for: 5m
        keep_firing_for: 10m
        labels:
          severity: warning
          service: 'Pub/Sub'
          namespace: cloud-provider-gcp
        annotations:
          summary: 'Unacknowledged messages for more than 60 seconds.'
          description: 'Investigate and speed up message processing; ensure consumers can handle the load.'
          dashboard_uid: '2abad1eb5e4873b95e9176e7ef10a30c'
